---
title: "Data cleaning and analysis"
author: "Karolina Frieszova"
date: "03/03/2021"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr, warn.conflicts = FALSE)
# Suppress summarise info
options(dplyr.summarise.inform = FALSE)

iris %>% 
  group_by(Species) %>% 
  summarise(
    Sepal.Length.mean = mean(Sepal.Length)
  )
```

# LOAN RISK PREDICTION

## 1. INTRODUCTION

### 1.1 Business Description

LendingClub is US peer-to-peer lending company and the world's largest peer-to-peer lending platform. LendingClub enables borrowers to create unsecured personal loans. Investors are able to search and browse the loan listings on LendingClub website and select loans that they want to invest in based on the information supplied about the borrower. This Internet financial application is a service which directly connects the individual investors and loan borrowers to establish credit relationships and complete the transaction procedures through online platform, without the intermediaries of commercial banks. Investors make money from the interest on these loans. LendingClub makes money by charging borrowers an origination fee and investors a service fee. 

### 1.2 Business Problem

Peer_to_peer online lending platform have brought opportunities to investors, but at the same time, they are also faced with the risk of user loan default, which is related to the sustainable and healthy development of platform.

The goal of this project is to help LendingClub to understand who is likely to default and who they should lend to in the future.

### 1.3 Data Source

## 2. DATA PREPERATION

### 2.1 Data Introdustion

The raw data from the LendingClub contains 42538 rows and 114 columns. Each observation represents one borrower and her/his information. The personal loans are between $500 to \$35000. The standard loan duration is 3 or 5 years. The period in which loans were funded is Jun 2007 to Dec 2011. The original data-set contains many different variables which LendingClub collects during different stages of loan process. Many of these variables have large amount of missing values or are arbitrary to building the loan risk model. 

Our data-set is joined with two data-sets that added a state name to the zip code, and reduced risk grading system from 35 grades to 7.

### 2.2 Data Cleaning

##### Packages used
```{r message=FALSE, echo=TRUE,cache=FALSE, results=TRUE, warning=FALSE, comment=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(janitor)
```

##### Reading in data and joing tables
```{r message=FALSE, echo=TRUE,cache=FALSE, results=TRUE, warning=FALSE, comment=FALSE, warning=FALSE}
 # read in data
grade_info <- read_csv(here("raw_data/grade_info.csv"))
lcd_dictionary <- read_csv(here("raw_data/LCDataDictionary.csv")) %>% 
  clean_names()
lending_club_loans <- read_csv(here("raw_data/lending_club_loans.csv"))
state_names <- read_csv(here("raw_data/state_names_info.csv"))

# add seven loan classifiers which indicate different levels of risk and corresponding returns
lending_club_loans <- left_join(lending_club_loans, grade_info, by = "sub_grade")

# add state names
lending_club_loans <- left_join(lending_club_loans, state_names, 
                                by = c("addr_state" = "state_abb"))
```

##### Initial variable reduction
In dealing with missing values, variables which contained a lot of missing values were removed, along with 32 observations that were missing across multiple columns. Other missing values were replaced with median imputation. 
```{r}
# remove columns in which stored value is only NA
lending_loans <- lending_club_loans %>% 
  select(-c(total_il_high_credit_limit, mths_since_last_major_derog, num_bc_tl,
            mths_since_rcnt_il, mths_since_recent_bc, mths_since_recent_bc_dlq, 
            mths_since_recent_inq, mths_since_recent_revol_delinq, total_bc_limit,
            total_bal_ex_mort, tot_hi_cred_lim, percent_bc_gt_75, pct_tl_nvr_dlq, 
            num_tl_120dpd_2m, num_tl_30dpd, num_tl_90g_dpd_24m, num_tl_op_past_12m,
            num_sats, num_rev_tl_bal_gt_0, num_rev_accts, num_op_rev_tl, num_il_tl,
            num_bc_sats, num_actv_rev_tl, num_actv_bc_tl, num_accts_ever_120_pd,
            mort_acc, mo_sin_rcnt_tl, mo_sin_old_il_acct, mo_sin_old_rev_tl_op,
            mo_sin_rcnt_rev_tl_op, bc_util, bc_open_to_buy, avg_cur_bal, 
            acc_open_past_24mths, inq_last_12m, total_cu_tl, total_rev_hi_lim,
            inq_fi, all_util, max_bal_bc, open_rv_24m, open_rv_12m, il_util,
            total_bal_il, open_il_24m, open_il_12m, open_il_6m, open_acc_6m,
            tot_cur_bal, tot_coll_amt, verification_status_joint, dti_joint, 
            annual_inc_joint))

# remove data-sets
rm(grade_info, state_names, lending_club_loans)

# further column reduction
lending_loans <- lending_loans %>% 
  select(-c(id, member_id, url, desc, last_pymnt_d, last_pymnt_amnt, last_credit_pull_d, # unrequited
            sub_grade, addr_state, # replaced with abbreviation
            tax_liens, # only one different value
            policy_code, # only policy code = 1 or NA, no policy code = 2
            initial_list_status, # False, NA
            collections_12_mths_ex_med, chargeoff_within_12_mths, # 0, NA 
            title, # high correlation with purpose
            emp_title, next_pymnt_d, # high cardinalty and a lot missing 
            zip_code, earliest_cr_line, # high cardinalty, not required
            funded_amnt, funded_amnt_inv, # highly correlated with loan_amount
            pymnt_plan, # only one True value - rest False
            total_pymnt_inv, # highly correlated with total_pymnt
            acc_now_delinq, # 4 rows = 1 all have loan_status = fully paid
            delinq_amnt, # 2 rows with loan_status = fully paid
            application_type, # all applications are individual
            mths_since_last_delinq, # 63.3 % missing values
            mths_since_last_record, # 91.4% missing vales
            out_prncp_inv, # highly correlated with out_prncp
            last_fico_range_low, # highly correlated with last_fico_range_high
            total_rec_prncp # highly correlated with total_pymnt (principal is the amount you borrowed without interest)
            )) %>% 
  drop_na(open_acc) # remove 32 rows as this rows are missing across multiple columns
```

##### Feature engineering

Target variable in our model is loan_status. The feature has 9 different values. Here they are explained:

- *Current:* Loan is up to date on all outstanding payments. 
- *In Grace Period:* Loan is past due but within the 15-day grace period. 
- *Fully paid:* Loan has been fully repaid, either at the expiration of the 3- or 5-year year term or as a result of a prepayment.
- *Default:* Loan has not been current for an extended period of time.
- *Charged Off:* Loan for which there is no longer a reasonable expectation of further payments. 
- *Late (16-30):* Loan has not been current for 16 to 30 days. 
- *Late (31-120):* Loan has not been current for 31 to 120 days.

For this analysis we are going to keep only observations where loan status contains values "Fully Paid" or "Charred Off". Since our goal is to try to understand if borrower is going to repay loan or not. We encode the variable so it represent only our two possibilities (1 for Fully Paid and 0 for Charged Off). As result our data-set will be reduced by 547 observations to 41959 in total. 

Further, our data-set have categorical variables containing many multiple labels. Then by using one hot encoding, we will expand the feature space dramatically. For this reason, the cardinally of some variables was reduced. 

```{r}
lending_loans <- lending_loans %>% 
  filter(!loan_status %in% c("Current", "In Grace Period", "Late (31-120 days)", "Late (16-30 days)", "Default")) %>%
  mutate(loan_status = case_when(loan_status == "Fully Paid" ~ T,
                                 loan_status == "Does not meet the credit policy. Status:Fully Paid" ~ T,
                                 loan_status == "Charged Off" ~ F,
                                 loan_status == "Does not meet the credit policy. Status:Charged Off" ~ F
                                 )) %>% # abstraction: loan status paid = 1, charged off = 0
  rename("addr_state" = "state_name") %>% 
  mutate(delinq_2yrs = ifelse(delinq_2yrs == 0, F, T), # past-due incidences of delinquency in the borrower's credit file for the past two years
         inq_last_6mths  = ifelse(inq_last_6mths == 0, F, T),
         pub_rec = ifelse(pub_rec == 0, F, T), # derogatory public records
         out_prncp = ifelse(out_prncp == 0, F, T), # Remaining outstanding principal for total amount funded
         total_rec_late_fee = ifelse(total_rec_late_fee == 0, F, T), # Late fees received to date
         recoveries = ifelse(recoveries == 0, F, T), # post charge off gross recovery
         collection_recovery_fee = ifelse(collection_recovery_fee == 0, F, T), # post charge off collection fee
         int_rate_pct = str_remove_all(int_rate, "[%]"),
         home_ownership = recode(home_ownership, "NONE" = "OTHER"),
         int_rate_pct = as.numeric(int_rate_pct), # convert interest rate to numeric
         issue_d = str_remove_all(issue_d, "[0-9-]"), # remove year, leave month
         emp_length = case_when(emp_length == "10+ years" ~ "10+ years",
                                emp_length %in% c("9 years", "8 years", "7 years", "6 years") ~ "above 5 years",
                                emp_length %in% c("5 years", "4 years", "3 years", "2 years") ~ "2 - 5 years",
                                emp_length %in% c("1 year", "< 1 year") ~ "1 and under",
                                emp_length == "n/a" ~ "unknows"),
         addr_state = coalesce(addr_state, "unknown"),
         revol_util_pct = str_remove_all(revol_util, "[%]"), # the amount of credit the borrower is using relative to all available revolving credit
         revol_util_pct = as.numeric(revol_util_pct), # convert to numeric
         revol_util_pct = coalesce(revol_util_pct, median(revol_util_pct, na.rm = TRUE)), # replace missing values with median
         pub_rec_bankruptcies = as.character(pub_rec_bankruptcies),
         pub_rec_bankruptcies = case_when(pub_rec_bankruptcies == "0" ~ "no", 
                                          pub_rec_bankruptcies == "1" ~ "yes",
                                          pub_rec_bankruptcies == "2" ~ "yes", 
                                          TRUE ~ "unknown"), # public record bankruptcies
         install_mth_pct = round((installment * 100) / (annual_inc/12), 2), # monthly installment expense %
         fico_range_avg = (fico_range_low + fico_range_high) / 2
         ) %>% 
  mutate_if(is_character, as_factor) %>% 
  select(-c(collection_recovery_fee, int_rate, revol_util, fico_range_low, fico_range_high, issue_d, addr_state))

```

The features related to the past incidences of delinquency, number of inquiries in past 6 months, number of derogatory public records, late fees received to date, and post charge off gross recovery were converted to the logical variable. As the common number of incidences was one or two. These values were assigned TRUE and where there were no record FALSE was assigned. Next, the missing values in Revolving line utilization rate were replaced with median imputation. And lastly, a feature was created that represents the monthly employment expense of the user's repayment expense as a percentage of monthly salary. 

Also, after closer analysis, I identified that we can't draw any strong conclusions of whether the 'Charge Off' is affected by the state variable, so we won't be adding 'addr_state' to our model. The same applies for the issue date.

## 3. EXPLANATORY ANALYSIS

After data cleaning, we can start with exploratory analysis on our narrowed feature selection. The main purpose of exploratory analysis is to help look at data before making any assumptions. It is one of the most important steps before building a model in order to identify obvious errors, as well as better understand patterns within the data, detect outliers or find interesting relations among the variables.

##### Distribution of Loans by Purpose of Loan

First we can look at the distribution of loans by the purpose. There are 14 different factors for this variable. For example, 46% of the loans were taken for debt_consolidation and 16% of them were not fully paid. In comparison to loans for 'small businesses', these loans make not even 5% but 28% of them were not fully paid. Therefore, can can assume that there may be some relationship between the target variable and the purpose. 

```{r}
# investigate the amount of charged off loans by purpose category
lending_loans %>% 
  filter(loan_status == F) %>% 
  group_by(purpose) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = reorder(purpose, count), y = count))+
  geom_col()+
  coord_flip()+
  labs(title = "The Amount of Charged-Off Loans by Purpose Category",
       y = "Frequency",
       x = "Purpose")
```

```{r}
# percentage loans by purpose category and Loan status
lending_loans %>% 
  group_by(purpose, loan_status) %>% 
  summarise(purchase_count = n()) %>% 
  mutate(pct = round(purchase_count * 100 / sum(purchase_count))) %>%
  ggplot(aes(x = purpose, y = pct, fill = loan_status))+
  geom_col()+
  coord_flip()+
  labs(title = "The Percentage of Loans by Purpose Category and Loan Status",
       y = "Frequency",
       x = "Purpose",
       fill = "Fully Paid")
```

```{r}
# add some categories together to minimise the categorical labels
lending_loans <- lending_loans %>% 
  mutate(purpose = case_when(purpose %in% c("home_improvement", "house") ~ "house related",
                             purpose %in% c("vacation", "wedding", "car", "major_purchase") ~ "personal",
                             T ~ as.character(purpose)))
```

##### Annual Income

Summary statistics of annual income. We can see that there are few outliers. However, we won't be dealing with them as after closer inspection we could we that our two borrowers with highest annual income took loan for home improvements and it was fully paid so we can well assume that this was the case.
```{r}
lending_loans %>% 
  mutate(annual_inc = annual_inc / 1000) %>% 
  group_by(annual_inc) %>% 
  summarise(frequency = n()) %>% 
  ggplot(aes(x = annual_inc, y = frequency))+
  geom_point()+
  labs(title = "Annual income",
       y = "Frequency",
       x = "Annual income (unit 1000)")
```
##### Distribution of Loans by Grading Score

Distribution of loans by grading system is another information that can be beneficial for LendingClub. Loan grading is a classification system that involves assigning a quality score to a loan based on a borrower's credit history, quality of the collateral, and the likelihood of repayment of the principal and interest. I have calculated the percentage of each grading for two loan statuses. We can see that the proportion of loans that are not fully paid increases for poorer risk grades.

```{r}
lending_loans %>% 
  select(grade, loan_status) %>% 
  group_by(grade, loan_status) %>% 
  mutate(grade = fct_relevel(grade, "A", "B", "C", "D", "E", "F", "G")) %>% 
  summarise(grade_count = n()) %>% 
  mutate(pct = round(grade_count * 100 / sum(grade_count))) %>% 
  ggplot(aes(x = grade, y = pct, fill = loan_status))+
  geom_col()+
  labs(title = "Distribution of Loans by Grading System and Loan Status",
       fill = "Fully Paid",
       y = "Percentage",
       x = "Grade")


lending_loans %>% 
  ggplot(aes(x = fico_range_avg, fill = loan_status))+
  geom_histogram(position = "dodge")+
  labs(title = "Distribution of Loans by Grading System and Loan Status",
       legend = "Fully Paid")

unique(lending_loans$fico_range_avg)
```


Check for aliases in the independent variables:
```{r}
alias(loan_status ~ ., data = lending_loans)
```

Check correlation between the features to decide which variables to include in the model. As we can see there is a strong positive correlation between loan amount and three other variables (installment (0.93), total_pymnt (0.88), and total_rec_int (0.73)), therefore, they can be excluded from our model. 

```{r}
cor(lending_loans[, sapply(lending_loans, class) == "numeric"])
lending_loans <- lending_loans %>% 
  select(-c(installment , total_pymnt, total_rec_int))
```


```{r}

```

```{r}
library(GGally)
loans_numeric <- lending_loans %>%
  select_if(is.numeric)

loans_nonnumeric <- lending_loans %>%
  select_if(function(x) !is.numeric(x))

loans_numeric$loan_status <- lending_loans$loan_status

names(loans_nonnumeric)
nonnumeric_1 <- loans_nonnumeric %>% 
  select(loan_status, term, verification_status, out_prncp, pub_rec_bankruptcies)

#ggpairs(nonnumeric_1)
```



